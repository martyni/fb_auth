<html>
<head>
<script src="https://www.brython.info/src/brython_dist.js"></script>
<script src="https://www.brython.info/src/brython_dist.js"></script>
<link rel="stylesheet" type="text/css" href="https://notdb.martyni.co.uk/authmartynicouk/file/style.css">
</head>
<body onload="brython()" >
<script type="text/python">
from browser import document, ajax, html, markdown
from browser.local_storage import storage
import json

api_url = "https://notdb.martyni.co.uk"

html_elements = {
"BLOCKQUOTE":html.BLOCKQUOTE,
"OBJECT":html.OBJECT,
"KEYGEN":html.KEYGEN,
"LINK":html.LINK,
"BR":html.BR,
"OPTGROUP":html.OPTGROUP,
"SUB":html.SUB,
"PRE":html.PRE,
"RP":html.RP,
"FRAME":html.FRAME,
"METER":html.METER,
"SOURCE":html.SOURCE,
"RB":html.RB,
"BODY":html.BODY,
"TH":html.TH,
"FIGURE":html.FIGURE,
"SVG":html.SVG,
"FIGCAPTION":html.FIGCAPTION,
"P":html.P,
"BASE":html.BASE,
"TFOOT":html.TFOOT,
"VAR":html.VAR,
"AUDIO":html.AUDIO,
"MAP":html.MAP,
"OL":html.OL,
"TEXTAREA":html.TEXTAREA,
"ACRONYM":html.ACRONYM,
"MENU":html.MENU,
"DT":html.DT,
"DIALOG":html.DIALOG,
"ADDRESS":html.ADDRESS,
"NAV":html.NAV,
"MAIN":html.MAIN,
"CODE":html.CODE,
"HR":html.HR,
"ISINDEX":html.ISINDEX,
"HEAD":html.HEAD,
"LABEL":html.LABEL,
"META":html.META,
"DEL":html.DEL,
"FONT":html.FONT,
"SELECT":html.SELECT,
"NOFRAMES":html.NOFRAMES,
"CENTER":html.CENTER,
"RTC":html.RTC,
"KBD":html.KBD,
"DATALIST":html.DATALIST,
"HTML":html.HTML,
"VIDEO":html.VIDEO,
"ARTICLE":html.ARTICLE,
"EM":html.EM,
"FRAMESET":html.FRAMESET,
"FIELDSET":html.FIELDSET,
"BASEFONT":html.BASEFONT,
"BDO":html.BDO,
"BDI":html.BDI,
"PARAM":html.PARAM,
"S":html.S,
"COMMAND":html.COMMAND,
"DETAILS":html.DETAILS,
"OUTPUT":html.OUTPUT,
"INPUT":html.INPUT,
"EMBED":html.EMBED,
"HEADER":html.HEADER,
"H2":html.H2,
"H3":html.H3,
"BUTTON":html.BUTTON,
"SCRIPT":html.SCRIPT,
"H6":html.H6,
"H4":html.H4,
"INS":html.INS,
"UL":html.UL,
"TIME":html.TIME,
"STRIKE":html.STRIKE,
"MATH":html.MATH,
"OPTION":html.OPTION,
"TITLE":html.TITLE,
"SECTION":html.SECTION,
"SUP":html.SUP,
"SMALL":html.SMALL,
"STRONG":html.STRONG,
"COL":html.COL,
"AREA":html.AREA,
"MENUITEM":html.MENUITEM,
"APPLET":html.APPLET,
"RT":html.RT,
"TABLE":html.TABLE,
"B":html.B,
"IMG":html.IMG,
"PROGRESS":html.PROGRESS,
"ASIDE":html.ASIDE,
"DFN":html.DFN,
"RUBY":html.RUBY,
"SPAN":html.SPAN,
"MARK":html.MARK,
"TRACK":html.TRACK,
"TEMPLATE":html.TEMPLATE,
"DL":html.DL,
"H1":html.H1,
"WBR":html.WBR,
"DD":html.DD,
"TBODY":html.TBODY,
"DIV":html.DIV,
"H5":html.H5,
"DATA":html.DATA,
"LEGEND":html.LEGEND,
"DIR":html.DIR,
"NOSCRIPT":html.NOSCRIPT,
"PICTURE":html.PICTURE,
"COLGROUP":html.COLGROUP,
"BIG":html.BIG,
"TT":html.TT,
"TR":html.TR,
"LI":html.LI,
"IFRAME":html.IFRAME,
"TD":html.TD,
"A":html.A,
"STYLE":html.STYLE,
"FORM":html.FORM,
"I":html.I,
"Q":html.Q,
"CAPTION":html.CAPTION,
"U":html.U,
"ABBR":html.ABBR,
"SUMMARY":html.SUMMARY,
"THEAD":html.THEAD,
"CANVAS":html.CANVAS,
"FOOTER":html.FOOTER,
"SAMP":html.SAMP,
"CITE":html.CITE
}

funcs = {}

try:
   print(storage["cache_hits"])
   hits = int(storage["cache_hits"])
   hits += 1
   print(hits)
   if not hits % 10:
      storage.clear()
      print("cache cleared")
   storage["cache_hits"] = str(hits)
except:
   storage["cache_hits"] = "0"

def base_request(url, call_back, cache):
    cache_hit = storage.get(url)
    if cache and cache_hit:
       print("cache hit :" + url)
       print("contents :" + cache_hit)
       cache(None, text=cache_hit)
       return None
    req = ajax.ajax()
    req.bind('complete', call_back)
    req.open('GET', url, True)
    print(url)
    req.send()

def on_complete(req, text=None):
    if text:
       stuff = json.loads(text)
    else:   
       stuff = json.loads(req.text)
    for i in stuff:
       pass


def get_page():
   get_links()
   base_request(api_url + "/authmartynicouk/list/page?reverse=true", update_page, None)

def update_navigation(req, text=None):
    if text:
       links = json.loads(text)
    else:
       links = json.loads(req.text)
    update_links(links)

def update_links(links):
    count = 0
    order = {}
    for element_link in links:
       document["navigation"] <= html_elements["LI"](id="nav" + str(count))
       req_url= api_url + element_link
       def add_item(req, count=count, text=None):
	  if text is not None:
	     item = json.loads(text)
	  else:
	     print(req.responseURL, " set to ",  req.text)
	     storage[req.responseURL] = req.text
             item = json.loads(req.text)
	  nav_place = str(count)
          document['nav' + nav_place] <= html_elements["A"](item["name"].title(), href=item["href"])
       order[count] = add_item
       base_request(req_url, order[count], order[count])
       count += 1	

def get_links():
    base_request(api_url + "/authmartynicouk/list/navigation", update_navigation, update_navigation)

def get_each_element(url, key=None):
   def each_element(req, text=None, key=key):
      if text:
         element = json.loads(text)
      else:
         element = json.loads(req.text)
         storage[req.responseURL] = req.text
      if type(element) == str:
         print(element)
         new_s = element.replace(r'\n', '').replace('""', "`").replace('\\','')
         element = json.loads(new_s)
      attributes = element["attributes"]
      article_footer = html_elements["P"]("</br>Author: <i>" + element["author"] + "</i>", Class="author") + html_elements["P"](element["date"], Class="date")
      article_header = html_elements["H1"](element["title"].title(), **attributes)
      if element.get("media"):
         print("media")
         article_header += html_elements["AUDIO"]("boop", src=element["media"],controls=True, type="audio/mpeg") 
      body, scripts = element["contents"]
      body = body.replace(r"`", "'").replace(r'\\n', '').replace(r"<p></p>","")
      article_body = html_elements["P"]( body , **attributes)	
      article = html_elements[element["type"]](article_header + article_body + article_footer)
      document[key] <= article
      for s in scripts:
         exec(script, globals())
      
   base_request(api_url + url, each_element, each_element)

def update_page(req, text=None):
   if text:
      page = json.loads(text)
   else:
      page = json.loads(req.text)
      storage[req.responseURL] = req.text
   counter = 0
   if page:
      for element_link in page:
         document['page'] <=html_elements["SPAN"]("", id=counter )
         print("added span" + str(counter))
         get_each_element(element_link, key=str(counter))
         counter += 1




get_page()
</script>
<div id="page">	
</div>
        {% if not session.logged_in %}
        <!--<p> You must login </p>-->
        {% else %}
        {% block content %}
        <!--<p> You are logged in </p>-->
        {% endblock%}
        {% endif%}
<nav >
     <ul id="navigation">	
        {% if not session.logged_in %}
        <li>
    	    <a href="{{ url_4("facebook_login") }}">Login</a>
        </li>
        {% else %}
        <li>
    	    <a href="{{ url_4("logout") }}">{{ user_name }} Logout</a>
        </li>
        {% endif %}
    </ul>
</nav>
</body>
</html>
